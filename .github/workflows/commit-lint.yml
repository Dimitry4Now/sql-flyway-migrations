name: Commit Message Lint

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  commit-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          #!/bin/bash
          
          # Get all commits in this PR
          commits=$(git log origin/${{ github.base_ref }}..${{ github.sha }} --pretty=format:"%H")
          
          # Date when commit format was enforced (change this to your date)
          ENFORCEMENT_DATE="2025-11-21"
          
          failed=false
          
          for commit in $commits; do
            commit_date=$(git log -1 --pretty=format:"%ci" $commit | cut -d' ' -f1)
            
            echo "Checking commit: $commit (Date: $commit_date)"
            
            # Skip commits before enforcement date
            if [[ "$commit_date" < "$ENFORCEMENT_DATE" ]]; then
              echo "⏭️  Skipping old commit (before $ENFORCEMENT_DATE)"
              echo "---"
              continue
            fi
            
            msg=$(git log -1 --pretty=format:"%B" $commit)
            
            # Check for required sections
            if ! echo "$msg" | grep -q "Files changed:"; then
              echo "❌ Commit $commit missing 'Files changed:' section"
              failed=true
            fi
            
            if ! echo "$msg" | grep -q "Purpose of the change:"; then
              echo "❌ Commit $commit missing 'Purpose of the change:' section"
              failed=true
            fi
            
            if ! echo "$msg" | grep -q "How does it affect the application:"; then
              echo "❌ Commit $commit missing 'How does it affect the application:' section"
              failed=true
            fi
            
            # Validate minimum length for Purpose
            purpose=$(echo "$msg" | sed -n '/Purpose of the change:/,/How does it affect/p' | grep -v "Purpose of the change:" | grep -v "How does it affect" | tr -d '\n' | xargs)
            purpose_len=${#purpose}
            if [ $purpose_len -lt 50 ]; then
              echo "❌ Commit $commit: 'Purpose' too short ($purpose_len chars, need 50+)"
              failed=true
            fi
            
            # Validate minimum length for Impact
            impact=$(echo "$msg" | sed -n '/How does it affect the application:/,/$/p' | grep -v "How does it affect the application:" | tr -d '\n' | xargs)
            impact_len=${#impact}
            if [ $impact_len -lt 50 ]; then
              echo "❌ Commit $commit: 'Application impact' too short ($impact_len chars, need 50+)"
              failed=true
            fi
            
            if [ "$failed" = false ]; then
              echo "✅ Commit $commit passes validation"
            fi
            echo "---"
          done
          
          if [ "$failed" = true ]; then
            echo ""
            echo "❌ One or more commits have invalid commit messages"
            echo "Please use the commit template format"
            exit 1
          fi
          
          echo "✅ All commits pass validation"
